@model Discounts.MVC.Models.Customer.MyCouponsViewModel

@{
	ViewData["Title"] = "ჩემი კუპონები";
}

<div class="container mt-5">
	<div class="d-flex justify-content-between align-items-center mb-4">
		<h2><i class="bi bi-person-lines-fill text-primary"></i> ჩემი ჯავშნები და კუპონები</h2>
	</div>

	@if (TempData["SuccessMessage"] != null)
	{
		<div class="alert alert-success alert-dismissible fade show shadow-sm" role="alert">
			<i class="bi bi-check-circle-fill"></i> @TempData["SuccessMessage"]
			<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
		</div>
	}
	@if (TempData["ErrorMessage"] != null)
	{
		<div class="alert alert-danger alert-dismissible fade show shadow-sm" role="alert">
			<i class="bi bi-exclamation-triangle-fill"></i> @TempData["ErrorMessage"]
			<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
		</div>
	}

	@if (!Model.ActiveReservations.Any() && !Model.PurchasedCoupons.Any())
	{
		<div class="alert alert-light border text-center py-5 shadow-sm">
			<i class="bi bi-ticket-perforated text-muted" style="font-size: 3rem;"></i>
			<h4 class="mt-3 text-secondary">თქვენ ჯერ არ გაქვთ დაჯავშნილი ან შეძენილი კუპონები</h4>
			<a asp-controller="Home" asp-action="Index" class="btn btn-outline-primary mt-3">ფასდაკლებების ნახვა</a>
		</div>
	}
	else
	{
		@if (Model.ActiveReservations.Any())
		{
			<h4 class="mb-3 mt-4"><i class="bi bi-clock-history text-warning"></i> ჩემი ჯავშნები</h4>
			<div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mb-5">
				@foreach (var coupon in Model.ActiveReservations)
				{
					bool isExpired = coupon.ExpiresAt < DateTime.UtcNow;

					<div class="col">
						<div class="card shadow-sm h-100 border-top border-4 @(isExpired ? "border-danger bg-light text-muted" : "border-warning")">
							<div class="card-body d-flex flex-column">

								<div class="d-flex justify-content-between align-items-start mb-3">
									<h6 class="text-uppercase fw-bold mb-0">ჯავშანი #@coupon.Id</h6>
									@if (isExpired)
									{
										<span class="badge bg-danger">ვადაგასული</span>
									}
									else
									{
										<span class="badge bg-warning text-dark">აქტიური</span>
									}
								</div>

								<h5 class="card-title fw-bold">@coupon.OfferTitle</h5>
								<p class="small mb-1">
									<i class="bi bi-calendar-plus"></i> დაჯავშნის დრო: @coupon.ReservedAt.ToLocalTime().ToString("g")
								</p>

								<hr class="mt-auto" />

								<div class="d-flex justify-content-between align-items-center">
									<div class="small @(isExpired ? "text-danger fw-bold" : "text-muted")">
										<i class="bi bi-clock-history"></i>
										ძალაშია: @coupon.ExpiresAt.ToLocalTime().ToString("HH:mm")
									</div>

									@if (!isExpired)
									{
										<form asp-controller="Purchase" asp-action="Buy" method="post">
											<input type="hidden" name="reservationId" value="@coupon.Id" />
											<button type="submit" class="btn btn-success btn-sm">
												<i class="bi bi-cart-check"></i> ყიდვა
											</button>
										</form>
									}
								</div>

							</div>
						</div>
					</div>
				}
			</div>
		}

		@if (Model.PurchasedCoupons.Any())
		{
			<h4 class="mb-3"><i class="bi bi-wallet2 text-success"></i> ნაყიდი კუპონები</h4>
			<div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
				@foreach (var coupon in Model.PurchasedCoupons)
				{

					bool isUsed = coupon.IsUsed;
					bool isExpired = !isUsed && (coupon.OfferEndDate < DateTime.UtcNow);
					bool isActive = !isUsed && !isExpired;

					string borderClass = isActive ? "border-success" : (isUsed ? "border-secondary" : "border-danger");
					string textClass = isActive ? "text-success" : (isUsed ? "text-secondary" : "text-danger");
					string iconClass = isActive ? "bi-check-circle-fill" : (isUsed ? "bi-ticket-detailed-fill" : "bi-x-circle-fill");
					string statusText = isActive ? "აქტიური" : (isUsed ? "გამოყენებული" : "ვადაგასული");

					<div class="col">
						<div class="card shadow-sm bg-light h-100 border-top border-4 @borderClass">
							<div class="card-body text-center d-flex flex-column justify-content-center">

								<h6 class="text-uppercase fw-bold mb-2 @textClass">
									<i class="bi @iconClass"></i> @statusText
								</h6>

								<h5 class="card-title fw-bold @(isActive ? "" : "text-muted text-decoration-line-through")">
									@coupon.OfferTitle
								</h5>

								<p class="small text-muted mb-3">შეძენის თარიღი: @coupon.SoldAt.ToLocalTime().ToString("g")</p>

								<div class="p-2 border rounded mt-auto @(isActive ? "border-success bg-white" : "border-secondary bg-light")">
									<span class="fs-4 fw-bold tracking-widest @(isActive ? "text-dark" : "text-muted")" style="letter-spacing: 2px;">
										@coupon.Code
									</span>
								</div>

							</div>
						</div>
					</div>
				}
			</div>
		}
	}
</div>
